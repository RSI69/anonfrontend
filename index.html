<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ANONToken – Stealth Transfer System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #ff0048;
      --secondary: #212121;
      --bg-dark: #0a0a0a;
      --bg-panel: #141414;
      --text: #e0e0e0;
      --text-dim: #9e9e9e;
      --success: #00cc66;
      --warning: #ff9100;
      --font-mono: 'Courier New', monospace;
    }
    body { background: var(--bg-dark); color: var(--text); font-family: 'Segoe UI', 'Roboto', sans-serif; }
    button { margin: 10px; padding: 10px 20px; border: none; background: var(--primary); color: white; cursor: pointer; border-radius: 6px; }
    .console { background: var(--bg-panel); padding: 10px; margin-top: 10px; border-radius: 8px; font-family: var(--font-mono); font-size: 0.9rem; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 10; }
    .modal-content { background: var(--bg-panel); padding: 20px; border-radius: 10px; max-width: 500px; width: 90%; text-align: center; }
    textarea { width: 100%; height: 60px; font-family: var(--font-mono); margin-bottom: 10px; background: var(--secondary); color: var(--text); border: none; border-radius: 6px; padding: 10px; }
  </style>
</head>
<body>
  <h1>ANONToken – Linea Sepolia Demo</h1>
  <button id="connect">Connect Wallet</button>
  <button id="mint" disabled>Mint 1 ANON</button>
  <button id="burn" disabled>Burn ANON to Stealth</button>

  <div id="mintConsole" class="console">Waiting...</div>
  <div id="burnConsole" class="console">Waiting...</div>

  <div id="stealthModal" class="modal">
    <div class="modal-content">
      <h2>Stealth Key Info</h2>
      <textarea id="pkeyText" readonly></textarea>
      <textarea id="stealthAddressText" readonly></textarea>
      <br>
      <button id="copyPKey">Copy Key</button>
      <button id="downloadPKey">Download Key</button>
      <button id="closeModal">Close</button>
    </div>
  </div>

<script type="module">
import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js';

const CONTRACT = '0xB61416Ae77c3c638864bDbF04b9aB6D2AA5b120C';
const ABI = [
  { name:'mint', type:'function', stateMutability:'payable', inputs:[], outputs:[] },
  { name:'requestBurn', type:'function', stateMutability:'payable', inputs:[{ name:'stealthRecipient', type:'address' }, { name:'signature', type:'bytes' }, { name:'userEntropy', type:'uint256' }], outputs:[] },
  { name:'registerStealthAddress', type:'function', stateMutability:'nonpayable', inputs:[{ name:'stealthRecipient', type:'address' }], outputs:[] },
  { name:'burnIds', type:'function', inputs:[{ name:'a', type:'address' }], outputs:[{ type:'uint256' }], stateMutability:'view' },
  { name:'mintPrice', type:'function', inputs:[], outputs:[{ type:'uint256' }], stateMutability:'view' },
  { name:'balanceOf', type:'function', inputs:[{ name:'a', type:'address' }], outputs:[{ type:'uint256' }], stateMutability:'view' }
];

const LINEA = '0xe705';
let provider, signer, contract, currentAccount;

const connectButton = document.getElementById('connect');
const mintButton = document.getElementById('mint');
const burnButton = document.getElementById('burn');
const mintConsole = document.getElementById('mintConsole');
const burnConsole = document.getElementById('burnConsole');
const stealthModal = document.getElementById('stealthModal');
const pkeyText = document.getElementById('pkeyText');
const stealthAddressText = document.getElementById('stealthAddressText');

function log(el, msg) { el.textContent = msg; }

async function connectWallet() {
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send('eth_requestAccounts', []);
  const network = await provider.getNetwork();
  if (network.chainId !== parseInt(LINEA, 16)) {
    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: LINEA }] });
  }
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT, ABI, signer);
  currentAccount = await signer.getAddress();
  mintButton.disabled = false;
  burnButton.disabled = false;
  log(mintConsole, 'Wallet Connected.');
}

async function mintToken() {
  const price = await contract.mintPrice();
  const tx = await contract.mint({ value: price });
  await tx.wait();
  log(mintConsole, 'Minted 1 ANON');
}

async function burnAnon() {
  const balance = await contract.balanceOf(currentAccount);
  if (balance.lt(ethers.utils.parseEther('1'))) {
    log(burnConsole, 'Not enough ANON to burn.');
    return;
  }
  const randomBytes = ethers.utils.randomBytes(32);
  const userEntropy = ethers.BigNumber.from(randomBytes).toString();
  const privKeyHex = ethers.utils.hexlify(randomBytes);
  const stealthWallet = new ethers.Wallet(privKeyHex);

  await (await contract.registerStealthAddress(stealthWallet.address)).wait();
  const burnId = await contract.burnIds(currentAccount);
  const digest = ethers.utils.solidityKeccak256(['address', 'address', 'address', 'uint256', 'uint256'], [currentAccount, stealthWallet.address, CONTRACT, burnId, (await provider.getNetwork()).chainId]);
  const signature = await signer.signMessage(ethers.utils.arrayify(digest));

  const ABS_FLOOR = ethers.utils.parseEther('0.001');
  const estGas = await contract.estimateGas.requestBurn(stealthWallet.address, signature, userEntropy, { value: ABS_FLOOR });
  const tx = await contract.requestBurn(stealthWallet.address, signature, userEntropy, { value: ABS_FLOOR, gasLimit: estGas.add(50000) });
  await tx.wait();

  pkeyText.value = privKeyHex;
  stealthAddressText.value = stealthWallet.address;
  stealthModal.style.display = 'flex';
}

document.getElementById('copyPKey').onclick = () => {
  pkeyText.select();
  document.execCommand('copy');
};

document.getElementById('downloadPKey').onclick = () => {
  const blob = new Blob([`Private Key: ${pkeyText.value}\nAddress: ${stealthAddressText.value}`], { type: 'text/plain' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'stealth_key.txt';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

document.getElementById('closeModal').onclick = () => {
  stealthModal.style.display = 'none';
};

connectButton.onclick = connectWallet;
mintButton.onclick = mintToken;
burnButton.onclick = burnAnon;
</script>

</body>
</html>
